const { Sequelize } = require('sequelize');

const sequelize = new Sequelize({
  dialect: 'oracle',
  host: '172.16.32.73',
  port: 1521,
  database: 'DWREPO',
  username: 'CGBRITO',
  password: 'cgkbrito',
  logging: false
});

async function assignMenusToEjecutivo() {
  try {
    console.log('🔌 Conectando a Oracle...');
    await sequelize.authenticate();
    console.log('✅ Conexión exitosa a Oracle');
    
    // 1. Verificar rol ejecutivo
    console.log('\n1️⃣ Verificando rol ejecutivo...');
    const ejecutivoRole = await sequelize.query(`
      SELECT ID, NAME FROM CGBRITO.ROLES WHERE NAME = 'Ejecutivo'
    `, { type: 'SELECT' });
    
    if (!ejecutivoRole || ejecutivoRole.length === 0) {
      console.log('❌ Rol ejecutivo no encontrado');
      return;
    }
    
    const role = ejecutivoRole[0];
    console.log('✅ Rol ejecutivo encontrado:');
    console.log(`   ID: ${role.ID}`);
    console.log(`   Nombre: ${role.NAME}`);
    
    // 2. Verificar si existe la tabla ROLE_MENU_PERMISSIONS
    console.log('\n2️⃣ Verificando tabla ROLE_MENU_PERMISSIONS...');
    const tableExists = await sequelize.query(`
      SELECT COUNT(*) as total FROM USER_TABLES WHERE TABLE_NAME = 'ROLE_MENU_PERMISSIONS'
    `, { type: 'SELECT' });
    
    if (tableExists[0].TOTAL === 0) {
      console.log('❌ Tabla ROLE_MENU_PERMISSIONS no existe, creándola...');
      
      await sequelize.query(`
        CREATE TABLE CGBRITO.ROLE_MENU_PERMISSIONS (
          ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          ROLE_ID NUMBER NOT NULL,
          MENU_ID NUMBER NOT NULL,
          CAN_VIEW NUMBER(1) DEFAULT 1,
          CAN_EDIT NUMBER(1) DEFAULT 0,
          CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
          CONSTRAINT FK_RMP_ROLE FOREIGN KEY (ROLE_ID) REFERENCES CGBRITO.ROLES(ID),
          CONSTRAINT FK_RMP_MENU FOREIGN KEY (MENU_ID) REFERENCES CGBRITO.MENUS(ID),
          CONSTRAINT UQ_RMP_ROLE_MENU UNIQUE (ROLE_ID, MENU_ID)
        )
      `, { type: 'DDL' });
      
      console.log('✅ Tabla ROLE_MENU_PERMISSIONS creada');
    } else {
      console.log('✅ Tabla ROLE_MENU_PERMISSIONS ya existe');
    }
    
    // 3. Obtener menús disponibles
    console.log('\n3️⃣ Obteniendo menús disponibles...');
    const availableMenus = await sequelize.query(`
      SELECT ID, NAME, PATH, ICON FROM CGBRITO.MENUS WHERE IS_ACTIVE = 1 ORDER BY ORDER_INDEX
    `, { type: 'SELECT' });
    
    console.log(`📋 Menús disponibles: ${availableMenus.length}`);
    availableMenus.forEach((menu, index) => {
      console.log(`   ${index + 1}. ${menu.NAME} (${menu.PATH})`);
    });
    
    // 4. Definir qué menús debe tener el ejecutivo
    const ejecutivoMenuNames = [
      'Dashboard',
      'Reportes',
      'Notificaciones',
      'Pagos Ejecutados'
    ];
    
    console.log('\n4️⃣ Asignando menús al rol ejecutivo...');
    console.log(`📋 Menús a asignar: ${ejecutivoMenuNames.length}`);
    
    let assignedCount = 0;
    let skippedCount = 0;
    
    for (const menuName of ejecutivoMenuNames) {
      try {
        // Buscar el menú por nombre
        const menu = availableMenus.find(m => m.NAME === menuName);
        
        if (menu) {
          // Verificar si ya existe la relación
          const existingRelation = await sequelize.query(`
            SELECT COUNT(*) as total FROM CGBRITO.ROLE_MENU_PERMISSIONS 
            WHERE ROLE_ID = :roleId AND MENU_ID = :menuId
          `, {
            replacements: { roleId: role.ID, menuId: menu.ID },
            type: 'SELECT'
          });
          
          if (existingRelation[0].TOTAL > 0) {
            console.log(`  ⚠️ Menú ${menuName} ya asignado`);
            skippedCount++;
          } else {
            // Asignar el menú
            await sequelize.query(`
              INSERT INTO CGBRITO.ROLE_MENU_PERMISSIONS (ROLE_ID, MENU_ID, CAN_VIEW, CAN_EDIT)
              VALUES (:roleId, :menuId, 1, 0)
            `, {
              replacements: { roleId: role.ID, menuId: menu.ID },
              type: 'INSERT'
            });
            
            console.log(`  ✅ Asignado: ${menuName}`);
            assignedCount++;
          }
        } else {
          console.log(`  ❌ Menú no encontrado: ${menuName}`);
        }
      } catch (error) {
        if (error.message.includes('ORA-00001')) {
          console.log(`  ⚠️ Menú ${menuName} ya asignado (duplicado)`);
          skippedCount++;
        } else {
          console.log(`  ❌ Error asignando ${menuName}: ${error.message}`);
        }
      }
    }
    
    console.log(`\n📊 Resumen de asignación:`);
    console.log(`   ✅ Asignados: ${assignedCount}`);
    console.log(`   ⚠️ Omitidos: ${skippedCount}`);
    console.log(`   ❌ Errores: ${ejecutivoMenuNames.length - assignedCount - skippedCount}`);
    
    // 5. Verificar menús asignados después de la operación
    console.log('\n5️⃣ Verificando menús asignados al ejecutivo...');
    const assignedMenus = await sequelize.query(`
      SELECT m.NAME, m.PATH, m.ICON, rmp.CAN_VIEW, rmp.CAN_EDIT
      FROM CGBRITO.MENUS m
      JOIN CGBRITO.ROLE_MENU_PERMISSIONS rmp ON m.ID = rmp.MENU_ID
      WHERE rmp.ROLE_ID = :roleId
      ORDER BY m.ORDER_INDEX
    `, {
      replacements: { roleId: role.ID },
      type: 'SELECT'
    });
    
    console.log(`📊 Menús del ejecutivo después de la asignación: ${assignedMenus.length}`);
    
    if (assignedMenus.length > 0) {
      console.log('\n🔐 Menús asignados:');
      assignedMenus.forEach((menu, index) => {
        console.log(`   ${index + 1}. ${menu.NAME} (${menu.PATH})`);
        console.log(`      Ver: ${menu.CAN_VIEW ? '✅' : '❌'}, Editar: ${menu.CAN_EDIT ? '✅' : '❌'}`);
      });
    }
    
    console.log('\n🎉 Asignación de menús al ejecutivo completada!');
    
  } catch (error) {
    console.error('❌ Error:', error.message);
  } finally {
    await sequelize.close();
  }
}

assignMenusToEjecutivo();
